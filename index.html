<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Withdraw</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Telegram WebApp -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Firebase RTDB -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial}
body{background:#0b0f1a;color:#fff}
.app{max-width:480px;margin:auto;padding:15px}
.card{
  background:#12172a;
  border:1px solid #2b335a;
  border-radius:18px;
  padding:16px
}
h2{margin-bottom:10px}
.info{
  background:#181f3a;
  padding:10px;
  border-radius:12px;
  font-size:13px;
  margin-bottom:12px
}
input,select,button{
  width:100%;
  padding:14px;
  margin-top:8px;
  border-radius:14px;
  border:none
}
input,select{
  background:#0f1428;
  color:#fff;
  border:1px solid #2b335a
}
button{
  margin-top:14px;
  background:linear-gradient(135deg,#6a5cff,#2ec7ff);
  color:#fff;
  font-size:16px
}
.live{
  background:#0f1428;
  border:1px dashed #2ec7ff;
  border-radius:12px;
  padding:10px;
  margin-top:8px;
  text-align:center
}
</style>
</head>

<body>

<div class="app">
  <div class="card">
    <h2>üí≥ Withdraw</h2>

    <div class="info" id="rules">Loading...</div>

    <input id="coins" type="number" placeholder="Enter coins" oninput="calc()">
    <div class="live" id="taka">üí° Enter coins</div>

    <select id="method">
      <option value="">Select Method</option>
      <option value="Bkash">Bkash</option>
      <option value="Nagad">Nagad</option>
    </select>

    <input id="account" placeholder="Account Number">
    <button onclick="submitWithdraw()">üöÄ Submit Withdraw</button>
  </div>
</div>

<script>
/* ============ TELEGRAM ============ */
const tg = Telegram.WebApp;
tg.ready();
tg.expand();

const user = tg.initDataUnsafe?.user;
if(!user){
  tg.close(); // ‚ùå ‡¶ï‡ßã‡¶®‡ßã ‡¶≤‡ßá‡¶ñ‡¶æ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá ‡¶®‡¶æ
}
const uid = user.id;

/* ============ FIREBASE RTDB ============ */
firebase.initializeApp({
  apiKey: "AIzaSyBl0PIm4lvZea96Bte3KaKQJvurGE1P8Es",
  databaseURL: "https://post-c7e41-default-rtdb.firebaseio.com",
  projectId: "post-c7e41",
  appId: "1:758133068153:web:28ef27e45d8037e0d49fa8"
});
const db = firebase.database();

/* ============ REFS ============ */
const adminRef = db.ref("adminControl/withdraw");
const userRef  = db.ref("users/" + uid);
const reqRef   = db.ref("withdraw_requests");

let ADMIN = {};
let USER  = {};

/* ============ LOAD ADMIN ============ */
adminRef.once("value", snap=>{
  if(!snap.exists()){
    rules.innerText = "Withdraw unavailable";
    return;
  }
  ADMIN = snap.val();
  loadUser();
});

/* ============ LOAD USER (AUTO CREATE) ============ */
function loadUser(){
  userRef.once("value", snap=>{
    if(!snap.exists()){
      userRef.set({
        balance: 0,
        totalInvites: 0
      });
      USER = { balance:0, totalInvites:0 };
    }else{
      USER = snap.val();
    }
    showRules();
  });
}

/* ============ SHOW RULES ============ */
function showRules(){
  rules.innerHTML = `
    üí∞ Rate: 1 Coin = ‡ß≥${ADMIN.coinRate}<br>
    üîª Min: ${ADMIN.minWithdrawCoins} coins<br>
    üî∫ Max: ${ADMIN.maxWithdrawCoins} coins<br>
    üë• Required Invites: ${ADMIN.minInvites}<br>
    üíº Your Balance: <b>${USER.balance}</b> coins
  `;
}

/* ============ CALCULATE ============ */
function calc(){
  const c = Number(coins.value);
  if(!c){
    taka.innerText = "üí° Enter coins";
    return;
  }
  taka.innerText = "üíµ You will get ‡ß≥" + (c * ADMIN.coinRate);
}

/* ============ SUBMIT WITHDRAW ============ */
function submitWithdraw(){
  const c = Number(coins.value);
  const m = method.value;
  const a = account.value.trim();

  if(!c || !m || !a){
    tg.showAlert("‚ö†Ô∏è All fields required");
    return;
  }
  if(c < ADMIN.minWithdrawCoins || c > ADMIN.maxWithdrawCoins){
    tg.showAlert("‚ö†Ô∏è Amount out of limit");
    return;
  }
  if(USER.totalInvites < ADMIN.minInvites){
    tg.showAlert("‚ö†Ô∏è Invite requirement not met");
    return;
  }
  if(USER.balance < c){
    tg.showAlert("‚ö†Ô∏è Insufficient balance");
    return;
  }

  const takaAmount = c * ADMIN.coinRate;

  reqRef.push({
    userId: uid,
    coins: c,
    taka: takaAmount,
    method: m,
    account: a,
    status: "pending",
    time: Date.now()
  });

  userRef.update({
    balance: USER.balance - c
  });

  tg.showAlert("‚úÖ Withdraw request sent");
  setTimeout(()=>tg.close(),1500);
}
</script>

</body>
</html>