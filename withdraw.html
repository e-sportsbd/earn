<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Withdraw</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Telegram -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore,
  doc,
  getDoc,
  addDoc,
  collection,
  updateDoc,
  increment
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* ===== TELEGRAM ===== */
const tg = Telegram.WebApp;
tg.ready();
tg.expand();

const tgUser = tg.initDataUnsafe?.user;
if(!tgUser){
  document.body.innerHTML="<h2 style='text-align:center;margin-top:60px'>Telegram user not found</h2>";
  throw "No User";
}
const uid = String(tgUser.id);

/* ===== FIREBASE ===== */
const firebaseConfig = {
  apiKey: "AIzaSyBl0PIm4lvZea96Bte3KaKQJvurGE1P8Es",
  projectId: "post-c7e41",
  appId: "1:758133068153:web:28ef27e45d8037e0d49fa8"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ===== GLOBAL ===== */
let CONFIG = {};
let USER = {};

/* ===== LOAD DATA ===== */
async function loadWithdraw(){
  /* ADMIN CONFIG */
  const cfgSnap = await getDoc(doc(db,"admin_config","withdraw"));
  if(!cfgSnap.exists()){
    showError("Withdraw system not set");
    return;
  }
  CONFIG = cfgSnap.data();

  if(CONFIG.withdrawEnabled === false){
    showError("Withdraw temporarily off");
    return;
  }

  /* USER DATA */
  const userSnap = await getDoc(doc(db,"users",uid));
  if(!userSnap.exists()){
    showError("User not found");
    return;
  }
  USER = userSnap.data();
  USER.balance = USER.balance || 0;
  USER.totalInvites = USER.totalInvites || 0;

  /* SHOW RULES */
  rules.innerHTML = `
  üí∞ Rate: 1 Coin = ‡ß≥${CONFIG.coinRate}<br>
  üîª Min: ${CONFIG.minWithdrawCoins} coins<br>
  üî∫ Max: ${CONFIG.maxWithdrawCoins} coins<br>
  üë• Required Invites: ${CONFIG.minInvites}<br>
  üíº Your Balance: <b>${USER.balance}</b> coins
  `;

  /* PAYMENT METHODS */
  method.innerHTML = `<option value="">Select Method</option>`;
  if(CONFIG.bkashEnabled) method.innerHTML += `<option>Bkash</option>`;
  if(CONFIG.nagadEnabled) method.innerHTML += `<option>Nagad</option>`;
}
loadWithdraw();

/* ===== HELPERS ===== */
function showError(msg){
  document.body.innerHTML = `
  <h2 style="text-align:center;margin-top:70px;color:#ff6b6b">
    ‚ùå ${msg}
  </h2>`;
}

window.calc = ()=>{
  const c = Number(coins.value);
  if(!c){ taka.innerHTML="üí° Enter coins"; return; }
  taka.innerHTML = `üíµ You will get ‡ß≥${c * CONFIG.coinRate}`;
};

/* ===== WITHDRAW ===== */
window.submitWithdraw = async ()=>{
  const c = Number(coins.value);
  const m = method.value;
  const a = account.value.trim();

  if(!c || !m || !a){
    tg.showAlert("‚ö†Ô∏è All fields required");
    return;
  }
  if(c < CONFIG.minWithdrawCoins || c > CONFIG.maxWithdrawCoins){
    tg.showAlert("‚ö†Ô∏è Amount out of limit");
    return;
  }
  if(USER.totalInvites < CONFIG.minInvites){
    tg.showAlert("‚ö†Ô∏è Invite requirement not met");
    return;
  }
  if(USER.balance < c){
    tg.showAlert("‚ö†Ô∏è Insufficient balance");
    return;
  }

  const takaAmount = c * CONFIG.coinRate;

  await addDoc(collection(db,"withdraw_requests"),{
    userId: uid,
    coins: c,
    taka: takaAmount,
    method: m,
    account: a,
    status: "pending",
    time: Date.now()
  });

  await updateDoc(doc(db,"users",uid),{
    balance: increment(-c)
  });

  tg.showAlert(`‚úÖ Request sent\n‡ß≥${takaAmount}`);
  setTimeout(()=>tg.close(),1500);
};
</script>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial}
body{background:#0b0f1a;color:#fff}
.app{max-width:480px;margin:auto;padding:15px}
.card{
  background:#12172a;
  border:1px solid #2b335a;
  border-radius:18px;
  padding:16px
}
h2{margin-bottom:10px}
.info{
  background:#181f3a;
  padding:10px;
  border-radius:12px;
  font-size:13px;
  margin-bottom:12px
}
input,select,button{
  width:100%;
  padding:14px;
  margin-top:8px;
  border-radius:14px;
  border:none
}
input,select{background:#0f1428;color:#fff;border:1px solid #2b335a}
button{
  margin-top:14px;
  background:linear-gradient(135deg,#6a5cff,#2ec7ff);
  color:#fff;font-size:16px
}
.live{
  background:#0f1428;
  border:1px dashed #2ec7ff;
  border-radius:12px;
  padding:10px;
  margin-top:8px;
  text-align:center
}
</style>
</head>

<body>
<div class="app">
  <div class="card">
    <h2>üí≥ Withdraw</h2>
    <div class="info" id="rules">Loading...</div>

    <input id="coins" type="number" placeholder="Enter coins" oninput="calc()">
    <div class="live" id="taka">üí° Enter coins</div>

    <select id="method"></select>
    <input id="account" placeholder="Account Number">

    <button onclick="submitWithdraw()">üöÄ Submit Withdraw</button>
  </div>
</div>
</body>
</html>